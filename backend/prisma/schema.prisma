generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  TRAINER
  BOARD
  STAFF
}

enum FinanceEntryType {
  INCOME
  EXPENSE
}

enum InviteCodeTargetType {
  CLUB
  TEAM
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  passwordHash String
  role         UserRole       @default(TRAINER)
  firstName    String?
  lastName     String?
  clubId       String?
  teamId       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  club         Club?          @relation(fields: [clubId], references: [id], onDelete: SetNull)
  team         Team?          @relation(fields: [teamId], references: [id], onDelete: SetNull)
  refreshTokens RefreshToken[]

  @@index([clubId])
  @@index([teamId])
}

model Club {
  id             String         @id @default(cuid())
  region         String
  name           String
  city           String
  normalizedName String
  normalizedCity String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  users          User[]
  teams          Team[]
  inviteCodes    InviteCode[]
  financeEntries FinanceEntry[]

  @@unique([normalizedName, normalizedCity])
  @@index([name, city])
}

model Team {
  id                 String       @id @default(cuid())
  clubId             String
  name               String
  ageGroup           String
  league             String
  normalizedName     String
  normalizedAgeGroup String
  normalizedLeague   String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  club               Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  users              User[]
  players            Player[]
  inviteCodes        InviteCode[]

  @@unique([clubId, normalizedName, normalizedAgeGroup, normalizedLeague], name: "team_unique_normalized")
  @@index([clubId])
}

model Player {
  id        String   @id @default(cuid())
  teamId    String
  firstName String
  lastName  String
  position  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
}

model InviteCode {
  id         String               @id @default(cuid())
  code       String               @unique
  targetType InviteCodeTargetType
  clubId     String?
  teamId     String?
  isActive   Boolean              @default(true)
  expiresAt  DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  club       Club?                @relation(fields: [clubId], references: [id], onDelete: Cascade)
  team       Team?                @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([teamId])
  @@index([isActive])
}

model FinanceEntry {
  id        String           @id @default(cuid())
  clubId    String
  amount    Decimal          @db.Decimal(12, 2)
  type      FinanceEntryType
  title     String
  date      DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  club      Club             @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId, date])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
