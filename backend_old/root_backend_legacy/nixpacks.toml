[phases.setup]
nixPkgs = ["nodejs_20"]

[phases.install]
cmds = ["sh -lc 'if [ -f backend/package.json ]; then cd backend; fi; npm ci'"]

[phases.build]
cmds = ["sh -lc 'if [ -f backend/package.json ]; then cd backend; fi; npm run build'"]

[start]
cmd = "sh -lc 'SCHEMA=$(find . -path "*/prisma/schema.prisma" -print -quit); if [ -z "$SCHEMA" ]; then echo "Prisma schema not found"; ls -la; exit 1; fi; ROOT=$(dirname "$SCHEMA")/..; npx prisma generate --schema "$SCHEMA" && npx prisma migrate deploy --schema "$SCHEMA" && node "$ROOT/dist/main.js"'"
